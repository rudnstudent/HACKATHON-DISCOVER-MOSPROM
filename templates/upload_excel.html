{% extends "base.html" %}

{% block title %}Загрузка Excel файла - Moscow Industry Database{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Заголовок -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold gradient-text">
                    <i class="fas fa-file-excel me-3"></i>
                    Загрузка Excel файла
                </h1>
                <p class="lead text-muted">
                    Загрузите Excel файл с данными о промышленных предприятиях для добавления в базу данных
                </p>
            </div>

            <!-- Форма загрузки -->
            <div class="card shadow-lg border-0">
                <div class="card-header gradient-bg text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-upload me-2"></i>
                        Выберите файл для загрузки
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="excelFile" class="form-label fw-bold">
                                <i class="fas fa-file-excel text-success me-2"></i>
                                Excel файл (.xlsx, .xls)
                            </label>
                            <input type="file" 
                                   class="form-control form-control-lg" 
                                   id="excelFile" 
                                   name="file" 
                                   accept=".xlsx,.xls"
                                   required>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Поддерживаемые форматы: .xlsx, .xls. Максимальный размер: 16 МБ
                            </div>
                        </div>

                        <!-- Дополнительные опции -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="validateData" checked>
                                    <label class="form-check-label" for="validateData">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Валидация данных
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="createBackup" checked>
                                    <label class="form-check-label" for="createBackup">
                                        <i class="fas fa-save me-1"></i>
                                        Создать резервную копию
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Кнопки -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-secondary btn-lg me-md-2" onclick="history.back()">
                                <i class="fas fa-arrow-left me-2"></i>Назад
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                                <i class="fas fa-upload me-2"></i>Загрузить файл
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Информация о процессе -->
            <div class="card mt-4 border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-info-circle text-info me-2"></i>
                        Что происходит при загрузке?
                    </h5>
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Проверка формата и размера файла
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Валидация структуры данных
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Обработка и импорт в базу данных
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Создание отчета о результатах
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно загрузки -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header gradient-bg text-white">
                <h5 class="modal-title">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Обработка файла
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <h6>Пожалуйста, подождите...</h6>
                <p class="text-muted mb-0">Файл обрабатывается и загружается в базу данных</p>
                
                <!-- Прогресс бар -->
                <div class="progress mt-3" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%"
                         id="progressBar">
                    </div>
                </div>
                <small class="text-muted" id="progressText">Подготовка к загрузке...</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('excelFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Пожалуйста, выберите файл для загрузки');
            return;
        }

        // Проверка размера файла (16 МБ)
        if (file.size > 16 * 1024 * 1024) {
            alert('Размер файла превышает 16 МБ');
            return;
        }

        // Показываем модальное окно загрузки
        loadingModal.show();
        
        // Симулируем прогресс загрузки
        simulateProgress();

        // Отправляем файл
        const formData = new FormData(form);
        
        fetch('/upload-excel', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Ошибка загрузки файла');
        })
        .then(data => {
            // Завершаем прогресс
            progressBar.style.width = '100%';
            progressText.textContent = 'Загрузка завершена!';
            
            setTimeout(() => {
                loadingModal.hide();
                // Редирект на страницу успеха
                window.location.href = `/upload-success?filename=${encodeURIComponent(data.filename)}&records=${data.records_processed}`;
            }, 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            loadingModal.hide();
            alert('Ошибка при загрузке файла: ' + error.message);
        });
    });

    function simulateProgress() {
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            progressBar.style.width = progress + '%';
            
            if (progress < 30) {
                progressText.textContent = 'Проверка файла...';
            } else if (progress < 60) {
                progressText.textContent = 'Валидация данных...';
            } else if (progress < 90) {
                progressText.textContent = 'Импорт в базу данных...';
            }
            
            if (progress >= 90) {
                clearInterval(interval);
            }
        }, 500);
    }
});
</script>
{% endblock %}
